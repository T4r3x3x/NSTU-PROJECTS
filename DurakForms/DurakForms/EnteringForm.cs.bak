using System.Net;

namespace DurakForms
{
    public partial class EnteringForm : Form
    {
        string nickname;
        IPAddress ip;
        Button currentCard;

        private Point Origin_Cursor;
        private Point Origin_Control;
        private bool BtnDragging = false;
        private Point[] cardButtonsPos = new Point[5];
        List<string> ourCardsNames = new List<string>();

        public EnteringForm()
        {
            InitializeComponent();
            this.MouseMove += new MouseEventHandler(MouseEvent);
            ourCardsNames.Add("00");
            ourCardsNames.Add("30");
            ourCardsNames.Add("21");
            ourCardsNames.Add("17");
            CardButtonGenerate(ourCardsNames.ToArray());
        }

        private void MouseEvent(object? sender, MouseEventArgs e)
        {
           // if(currentCard != null)
          //      currentCard.GetType().GetProperty("Location").SetValue(currentCard,new Point(Cursor.Position.X,Cursor.Position.Y));
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            //    MessageBox.Show("alarm");
           // CardButtonGenerate();
            Client.form = this;
        }


        private void HostingButton_Click(object sender, EventArgs e)
        {
            if (CheckNickname())
            {
                Client.StartHosting(nickname);
                ShowGameTable();
            }
        }

        private void ConnectButton_Click(object sender, EventArgs e)
        {

            string _ip = IpInputBox.Text;//.Replace(' ', '.');                
            if (IPAddress.TryParse(_ip, out ip))
            {
                if (CheckNickname())
                {
                    Client.Connect(nickname, ip);
                    ShowGameTable();
                }
            }
            else
                MessageBox.Show("input ip adress");

        }


        bool CheckNickname()
        {
            if (NickNameBox.Text == "")
            {
                MessageBox.Show("input nickname");
                return false;
            }
            else
                return true;
        }


        void ShowEnteringForm()
        {
            HideObjectsWithTag("Game");
            ShowObjectsWithTag("Enter");
        }

        void ShowGameTable()
        {
            HideObjectsWithTag("Enter");
            ShowObjectsWithTag("Game");
        }

        void HideObjectsWithTag(string tag)
        {
            foreach (Control obj in Controls)
                if (obj.Tag == tag)
                    obj.Hide();
        }
        void ShowObjectsWithTag(string tag)
        {
            foreach (Control obj in Controls)
                if (obj.Tag == tag)
                    obj.Hide();
        }

        internal void CardButtonGenerate(string[] card_names)//string[] card_names)
        {
            int x = 20, y = 20;
            
                for (int i = 0; i < card_names.Length; i++)
                {
                    CreateButton(x, y,card_names[i]);
                    x += 168;
                }
                x = 20;
                y += 235;
           

            //foreach (var name in card_names)
            //{

            //}
        }

        public void CreateButton(int x, int y, string card_name) // 1 - Создание фуккции создание кнопки
        {
            Button btn = new Button();
            btn.Text = null;
            btn.Size = new Size(158, 225);
            btn.Location = new Point(x, y);
            btn.Click += new EventHandler(CardButton_Click);
            btn.BackgroundImage = GetCardImage(card_name);
            btn.BackgroundImageLayout = ImageLayout.Stretch;
            btn.FlatAppearance.BorderColor = Color.Gold;
            btn.FlatAppearance.BorderSize = 5;
            btn.FlatStyle = FlatStyle.Standard;
            //  btn.MouseUp += new MouseEventHandler(CardButton_MouseUp);
            btn.MouseDown += new MouseEventHandler(CardButton_MouseDown);
      //      btn.MouseMove += new MouseEventHandler(CardButton_MouseMove);
            Controls.Add(btn);
        }

        private void CardButton_Click(object sender, EventArgs e) // 2 - Обработчик кнопки
        {
         //   // MessageBox.Show("alarm");
          //  currentCard = (Button)sender;
        }

        private Bitmap GetCardImage(string card_name)
        {
            string path = string.Format(@"cards images\{0}.gif", card_name);
            return new Bitmap(path);
        }

        //private void CardButton_MouseUp(object sender, MouseEventArgs e)
        //{
        //    BtnDragging = false;
        //}

        private void CardButton_MouseDown(object sender, MouseEventArgs e)
        {
            currentCard = (Button) sender;
            

            foreach (Control button in this.Controls)
            {
                if (button.GetType() == typeof(Button))
                    ((Button)button).FlatStyle = FlatStyle.Standard;
            }
            currentCard.FlatStyle = FlatStyle.Flat;
            //   currentCard.
            //Button ct = sender as Button;
            //ct.Capture = true;
            //Origin_Cursor = Cursor.Position;
            //Origin_Control = ct.Location;
            //BtnDragging = true;
        }

        //private void CardButton_MouseMove(object sender, MouseEventArgs e)
        //{
        //    if (BtnDragging)
        //    {
        //        Button ct = sender as Button;
        //        ct.Left = Origin_Control.X - (Origin_Cursor.X - Cursor.Position.X);
        //        ct.Top = Origin_Control.Y - (Origin_Cursor.Y - Cursor.Position.Y);
        //    }
        //}


        internal void UpdateTable(string[] messages)
        {
            
                CardButtonGenerate(messages[0].Split(' '));
            
            
        }

        private void IpInputBox_TextChanged(object sender, EventArgs e)
        {

        }
        private void NickNameBox_TextChanged(object sender, EventArgs e)
        {
            nickname = NickNameBox.Text;
        }

    }
}